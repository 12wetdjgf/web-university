/**
 * Webå¤§å­¦ - æ™ºèƒ½æ—¥ç¨‹ç³»ç»Ÿ
 * ç¥ç»ç½‘ç»œå¼ä»»åŠ¡åŒ¹é…ï¼šè¾“å…¥å½“å‰çŠ¶æ€ â†’ è¾“å‡ºæœ€é€‚åˆçš„ä»»åŠ¡
 */

// ============================================
// æ•°æ®ç»“æ„ä¸å­˜å‚¨
// ============================================

const STORAGE_KEY = 'webuni_tasks';

// é»˜è®¤ä»»åŠ¡æ± ï¼ˆåŸºäºä½ çš„ç›®æ ‡é¢„è®¾ï¼‰
const DEFAULT_TASKS = [
    // å­¦ä¸š
    { id: 'd1', title: 'å¤ä¹ æœºæ¢°åˆ¶å›¾', category: 'study', energy: 2, time: 30, urgency: 3, xp: 30 },
    // è¯­è¨€
    { id: 'd2', title: 'èƒŒ20ä¸ªé›…æ€å•è¯', category: 'language', energy: 1, time: 15, urgency: 2, xp: 15 },
    { id: 'd3', title: 'çœ‹ä¸€é›†ç¾å‰§(è‹±æ–‡å­—å¹•)', category: 'language', energy: 1, time: 45, urgency: 1, xp: 20 },
    { id: 'd4', title: 'å’ŒGPTè‹±è¯­å¯¹è¯10åˆ†é’Ÿ', category: 'language', energy: 2, time: 15, urgency: 2, xp: 25 },
    { id: 'd5', title: 'å­¦ç²¤è¯­æ—¥å¸¸ç”¨è¯­', category: 'language', energy: 1, time: 20, urgency: 1, xp: 15 },
    // æŠ€æœ¯
    { id: 'd6', title: 'CS61Aä¸€ä¸ªå°èŠ‚', category: 'tech', energy: 3, time: 60, urgency: 2, xp: 50 },
    { id: 'd7', title: 'åˆ·ä¸€é“LeetCode', category: 'tech', energy: 3, time: 30, urgency: 1, xp: 35 },
    { id: 'd8', title: 'ç”¨Cursoråšä¸€ä¸ªå°é¡¹ç›®', category: 'tech', energy: 2, time: 60, urgency: 1, xp: 40 },
    // å¥åº·
    { id: 'd9', title: 'å‡ºé—¨èµ°15åˆ†é’Ÿ', category: 'health', energy: 1, time: 15, urgency: 1, xp: 20 },
    { id: 'd10', title: 'åš10ä¸ªä¿¯å§æ’‘', category: 'health', energy: 2, time: 5, urgency: 1, xp: 15 },
    { id: 'd11', title: 'æ•´ç†æˆ¿é—´', category: 'health', energy: 1, time: 20, urgency: 2, xp: 20 },
    // æˆé•¿
    { id: 'd12', title: 'ç”¨NotebookLMè¯»ä¸€ç¯‡æ–‡ç« ', category: 'growth', energy: 2, time: 30, urgency: 1, xp: 25 },
    { id: 'd13', title: 'å¬ä¸€é¦–æ–°æ­Œ', category: 'growth', energy: 1, time: 5, urgency: 1, xp: 10 },
];

// è·å–æ‰€æœ‰ä»»åŠ¡
function getTasks() {
    try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            return JSON.parse(stored);
        }
    } catch (e) {
        console.warn('Failed to load tasks:', e);
    }
    // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆå§‹åŒ–é»˜è®¤ä»»åŠ¡
    const tasks = DEFAULT_TASKS.map(t => ({
        ...t,
        status: 'todo',
        createdAt: new Date().toISOString(),
        completedAt: null
    }));
    saveTasks(tasks);
    return tasks;
}

// ä¿å­˜ä»»åŠ¡
function saveTasks(tasks) {
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    } catch (e) {
        console.warn('Failed to save tasks:', e);
    }
}


// ============================================
// æ ¸å¿ƒï¼šæ™ºèƒ½åŒ¹é…ç®—æ³•
// ============================================

/**
 * è®¡ç®—ä»»åŠ¡ä¸å½“å‰çŠ¶æ€çš„åŒ¹é…åˆ†æ•°
 * ç±»ä¼¼ç¥ç»ç½‘ç»œçš„åŠ æƒæ±‚å’Œï¼Œè¾“å…¥çŠ¶æ€å‘é‡ â†’ è¾“å‡ºåŒ¹é…åº¦
 */
function calculateMatchScore(task, state) {
    let score = 0;
    
    // 1. ç²¾åŠ›åŒ¹é…ï¼ˆæƒé‡æœ€é«˜ï¼‰
    // ç²¾åŠ›ä½æ—¶æ¨èä½èƒ½è€—ä»»åŠ¡ï¼Œç²¾åŠ›é«˜æ—¶å¯ä»¥åšé«˜èƒ½è€—ä»»åŠ¡
    const energyDiff = state.energy - task.energy;
    if (energyDiff >= 0) {
        score += 30; // ç²¾åŠ›è¶³å¤Ÿ
        if (energyDiff === 0) score += 10; // ç²¾åŠ›åˆšå¥½åŒ¹é…ï¼Œé¢å¤–åŠ åˆ†
    } else {
        score -= 40; // ç²¾åŠ›ä¸è¶³ï¼Œå¤§å¹…æ‰£åˆ†
    }
    
    // 2. æ—¶é—´åŒ¹é…
    if (task.time <= state.time) {
        score += 25;
        // æ—¶é—´åˆ©ç”¨ç‡è¶Šé«˜è¶Šå¥½ï¼ˆé¿å…æ¨è5åˆ†é’Ÿä»»åŠ¡ç»™2å°æ—¶ç©ºé—²ï¼‰
        const utilization = task.time / state.time;
        if (utilization > 0.5) score += 10;
    } else {
        score -= 30; // æ—¶é—´ä¸å¤Ÿ
    }
    
    // 3. å¿ƒæƒ…è°ƒèŠ‚
    if (state.mood === 'anxious') {
        // ç„¦è™‘æ—¶ï¼šæ¨èä½ç²¾åŠ›ã€çŸ­æ—¶é—´ã€èƒ½å¿«é€Ÿå®Œæˆçš„ä»»åŠ¡
        if (task.energy === 1) score += 20;
        if (task.time <= 20) score += 15;
        if (task.category === 'health') score += 15; // è¿åŠ¨å‡å‹
        if (task.category === 'growth' && task.time <= 15) score += 10; // å¬éŸ³ä¹ç­‰
    } else if (state.mood === 'energetic') {
        // ç§¯ææ—¶ï¼šæ¨èé«˜ä»·å€¼ã€æœ‰æŒ‘æˆ˜çš„ä»»åŠ¡
        if (task.energy === 3) score += 15;
        if (task.xp >= 30) score += 10;
        if (task.category === 'tech' || task.category === 'study') score += 10;
    }
    // calmçŠ¶æ€ä¸åšç‰¹æ®Šè°ƒæ•´ï¼Œä¿æŒä¸­æ€§
    
    // 4. ç´§æ€¥ç¨‹åº¦åŠ æˆ
    score += task.urgency * 8;
    
    // 5. XPå¥–åŠ±ï¼ˆè½»å¾®å½±å“ï¼Œé¼“åŠ±é«˜ä»·å€¼ä»»åŠ¡ï¼‰
    score += Math.min(task.xp / 5, 10);
    
    return score;
}

/**
 * è·å–æ¨èä»»åŠ¡åˆ—è¡¨
 * @param {Object} state - å½“å‰çŠ¶æ€ {energy, time, mood}
 * @returns {Array} æ’åºåçš„æ¨èä»»åŠ¡ï¼ˆæœ€å¤š5ä¸ªï¼‰
 */
function getRecommendations(state) {
    const tasks = getTasks().filter(t => t.status !== 'done');
    
    // è®¡ç®—æ¯ä¸ªä»»åŠ¡çš„åŒ¹é…åˆ†æ•°
    const scored = tasks.map(task => ({
        ...task,
        matchScore: calculateMatchScore(task, state)
    }));
    
    // æŒ‰åˆ†æ•°æ’åºï¼Œå–å‰5ä¸ª
    scored.sort((a, b) => b.matchScore - a.matchScore);
    
    return scored.slice(0, 5).filter(t => t.matchScore > 0);
}


// ============================================
// UI äº¤äº’é€»è¾‘
// ============================================

// å½“å‰é€‰æ‹©çš„çŠ¶æ€
let currentState = {
    energy: null,
    time: null,
    mood: null
};

// DOM å…ƒç´ ç¼“å­˜
let elements = {};

document.addEventListener('DOMContentLoaded', () => {
    cacheElements();
    initStateSelectors();
    initTaskModal();
    initFilters();
    renderTaskList();
});

function cacheElements() {
    elements = {
        energySelector: document.getElementById('energySelector'),
        timeSelector: document.getElementById('timeSelector'),
        moodSelector: document.getElementById('moodSelector'),
        recommendBtn: document.getElementById('getRecommendation'),
        recommendations: document.getElementById('recommendations'),
        recommendationList: document.getElementById('recommendationList'),
        anxietyMode: document.getElementById('anxietyMode'),
        taskList: document.getElementById('taskList'),
        emptyState: document.getElementById('emptyState'),
        taskModal: document.getElementById('taskModal'),
        taskForm: document.getElementById('taskForm'),
        addTaskBtn: document.getElementById('addTaskBtn'),
        closeModal: document.getElementById('closeModal'),
        cancelTask: document.getElementById('cancelTask'),
        filterBtns: document.querySelectorAll('.filter-btn')
    };
}

function initStateSelectors() {
    // ç²¾åŠ›é€‰æ‹©
    elements.energySelector.addEventListener('click', (e) => {
        const btn = e.target.closest('.state-btn');
        if (btn) {
            selectState('energy', parseInt(btn.dataset.value), elements.energySelector);
        }
    });
    
    // æ—¶é—´é€‰æ‹©
    elements.timeSelector.addEventListener('click', (e) => {
        const btn = e.target.closest('.state-btn');
        if (btn) {
            selectState('time', parseInt(btn.dataset.value), elements.timeSelector);
        }
    });
    
    // å¿ƒæƒ…é€‰æ‹©
    elements.moodSelector.addEventListener('click', (e) => {
        const btn = e.target.closest('.state-btn');
        if (btn) {
            selectState('mood', btn.dataset.value, elements.moodSelector);
            // ç„¦è™‘æ¨¡å¼ç‰¹æ®Šå¤„ç†
            if (btn.dataset.value === 'anxious') {
                elements.anxietyMode.classList.remove('hidden');
            } else {
                elements.anxietyMode.classList.add('hidden');
            }
        }
    });
    
    // è·å–æ¨èæŒ‰é’®
    elements.recommendBtn.addEventListener('click', showRecommendations);
    
    // ç„¦è™‘æ¨¡å¼å¿«æ·æ“ä½œ
    document.querySelectorAll('.relief-btn').forEach(btn => {
        btn.addEventListener('click', () => handleReliefAction(btn.dataset.action));
    });
}

function selectState(type, value, container) {
    // æ›´æ–°çŠ¶æ€
    currentState[type] = value;
    
    // æ›´æ–°UI
    container.querySelectorAll('.state-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    const activeBtn = container.querySelector(`[data-value="${value}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    // æ£€æŸ¥æ˜¯å¦å¯ä»¥è·å–æ¨è
    checkRecommendReady();
}

function checkRecommendReady() {
    const ready = currentState.energy && currentState.time && currentState.mood;
    elements.recommendBtn.disabled = !ready;
}

function showRecommendations() {
    const recommendations = getRecommendations(currentState);
    
    if (recommendations.length === 0) {
        elements.recommendationList.innerHTML = `
            <div class="no-recommendations">
                <p>æ²¡æœ‰åŒ¹é…çš„ä»»åŠ¡ï¼Œè¯•è¯•æ·»åŠ æ–°ä»»åŠ¡ï¼Ÿ</p>
            </div>
        `;
    } else {
        elements.recommendationList.innerHTML = recommendations.map((task, index) => `
            <div class="recommendation-card ${index === 0 ? 'top-pick' : ''}" data-id="${task.id}">
                ${index === 0 ? '<span class="top-badge">ğŸ¯ æœ€ä½³åŒ¹é…</span>' : ''}
                <div class="rec-header">
                    <span class="rec-category">${getCategoryIcon(task.category)}</span>
                    <span class="rec-title">${task.title}</span>
                </div>
                <div class="rec-meta">
                    <span>â±ï¸ ${task.time}åˆ†é’Ÿ</span>
                    <span>âœ¨ +${task.xp}XP</span>
                </div>
                <button class="start-task-btn" data-id="${task.id}">å¼€å§‹åš</button>
            </div>
        `).join('');
        
        // ç»‘å®šå¼€å§‹æŒ‰é’®
        elements.recommendationList.querySelectorAll('.start-task-btn').forEach(btn => {
            btn.addEventListener('click', () => startTask(btn.dataset.id));
        });
    }
    
    elements.recommendations.classList.remove('hidden');
    elements.recommendations.scrollIntoView({ behavior: 'smooth' });
}

function getCategoryIcon(category) {
    const icons = {
        study: 'ğŸ“',
        language: 'ğŸŒ',
        tech: 'ğŸ’»',
        health: 'ğŸƒ',
        income: 'ğŸ’°',
        social: 'ğŸ‘¥',
        growth: 'ğŸ“š',
        other: 'ğŸ“Œ'
    };
    return icons[category] || 'ğŸ“Œ';
}


// ============================================
// ä»»åŠ¡æ“ä½œ
// ============================================

function startTask(taskId) {
    const tasks = getTasks();
    const task = tasks.find(t => t.id === taskId);
    if (task) {
        task.status = 'doing';
        saveTasks(tasks);
        renderTaskList();
        // æ»šåŠ¨åˆ°ä»»åŠ¡åˆ—è¡¨
        elements.taskList.scrollIntoView({ behavior: 'smooth' });
    }
}

function completeTask(taskId) {
    const tasks = getTasks();
    const task = tasks.find(t => t.id === taskId);
    if (task && task.status !== 'done') {
        task.status = 'done';
        task.completedAt = new Date().toISOString();
        saveTasks(tasks);
        
        // ä½¿ç”¨æ–°çš„æ¸¸æˆåŒ–ç³»ç»Ÿ
        if (window.WebUni && window.WebUni.onTaskComplete) {
            const result = window.WebUni.onTaskComplete(task.xp);
            showCompletionFeedback(task, result);
        } else {
            showCompletionFeedback(task, null);
        }
        
        renderTaskList();
    }
}

function deleteTask(taskId) {
    if (!confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) return;
    const tasks = getTasks().filter(t => t.id !== taskId);
    saveTasks(tasks);
    renderTaskList();
}

function showCompletionFeedback(task, result) {
    const feedback = document.createElement('div');
    feedback.className = 'completion-toast';
    
    if (result && result.leveledUp) {
        feedback.innerHTML = `ğŸ‰ å‡çº§äº†ï¼Lv.${result.newLevel} ${result.title}<br>+${task.xp}XP`;
        feedback.classList.add('level-up');
    } else {
        feedback.innerHTML = `âœ¨ å®Œæˆï¼+${task.xp}XP`;
    }
    
    document.body.appendChild(feedback);
    
    setTimeout(() => feedback.classList.add('show'), 10);
    setTimeout(() => {
        feedback.classList.remove('show');
        setTimeout(() => feedback.remove(), 300);
    }, result?.leveledUp ? 3000 : 2000);
}

function handleReliefAction(action) {
    const reliefTasks = {
        run: { title: 'å‡ºé—¨èµ°èµ°/è·‘æ­¥', category: 'health', time: 15, xp: 25 },
        music: { title: 'å¬å‡ é¦–å–œæ¬¢çš„æ­Œ', category: 'growth', time: 10, xp: 15 },
        meditate: { title: 'æ·±å‘¼å¸å†¥æƒ³5åˆ†é’Ÿ', category: 'health', time: 5, xp: 20 }
    };
    
    const relief = reliefTasks[action];
    if (relief) {
        // åˆ›å»ºä¸´æ—¶ä»»åŠ¡å¹¶æ ‡è®°ä¸ºè¿›è¡Œä¸­
        const tasks = getTasks();
        const newTask = {
            id: 'relief_' + Date.now(),
            ...relief,
            energy: 1,
            urgency: 1,
            status: 'doing',
            createdAt: new Date().toISOString(),
            completedAt: null,
            isRelief: true
        };
        tasks.unshift(newTask);
        saveTasks(tasks);
        renderTaskList();
        
        elements.anxietyMode.classList.add('hidden');
        elements.taskList.scrollIntoView({ behavior: 'smooth' });
    }
}

// ============================================
// ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“
// ============================================

let currentFilter = 'all';

function initFilters() {
    elements.filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            elements.filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentFilter = btn.dataset.filter;
            renderTaskList();
        });
    });
}

function renderTaskList() {
    const tasks = getTasks();
    let filtered = tasks;
    
    if (currentFilter !== 'all') {
        filtered = tasks.filter(t => t.status === currentFilter);
    }
    
    if (filtered.length === 0) {
        elements.emptyState.classList.remove('hidden');
        elements.taskList.innerHTML = '';
        elements.taskList.appendChild(elements.emptyState);
        return;
    }
    
    elements.emptyState.classList.add('hidden');
    
    // æŒ‰çŠ¶æ€åˆ†ç»„æ’åºï¼šdoing > todo > done
    const statusOrder = { doing: 0, todo: 1, done: 2 };
    filtered.sort((a, b) => statusOrder[a.status] - statusOrder[b.status]);
    
    elements.taskList.innerHTML = filtered.map(task => `
        <div class="task-card ${task.status}" data-id="${task.id}">
            <div class="task-status-indicator"></div>
            <div class="task-content">
                <div class="task-header">
                    <span class="task-category">${getCategoryIcon(task.category)}</span>
                    <span class="task-title">${task.title}</span>
                </div>
                <div class="task-meta">
                    <span>â±ï¸ ${task.time}åˆ†é’Ÿ</span>
                    <span>âš¡ ${getEnergyLabel(task.energy)}</span>
                    <span>âœ¨ ${task.xp}XP</span>
                </div>
            </div>
            <div class="task-actions">
                ${task.status === 'todo' ? `<button class="action-btn start" data-action="start" data-id="${task.id}">â–¶ï¸</button>` : ''}
                ${task.status === 'doing' ? `<button class="action-btn complete" data-action="complete" data-id="${task.id}">âœ…</button>` : ''}
                ${task.status !== 'done' ? `<button class="action-btn delete" data-action="delete" data-id="${task.id}">ğŸ—‘ï¸</button>` : ''}
            </div>
        </div>
    `).join('');
    
    // ç»‘å®šæ“ä½œæŒ‰é’®
    elements.taskList.querySelectorAll('.action-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (action === 'start') startTask(id);
            else if (action === 'complete') completeTask(id);
            else if (action === 'delete') deleteTask(id);
        });
    });
}

function getEnergyLabel(energy) {
    return ['', 'ä½', 'ä¸­', 'é«˜'][energy] || 'ä¸­';
}


// ============================================
// ä»»åŠ¡å¼¹çª—
// ============================================

let editingTaskId = null;

function initTaskModal() {
    elements.addTaskBtn.addEventListener('click', () => openModal());
    elements.closeModal.addEventListener('click', closeModal);
    elements.cancelTask.addEventListener('click', closeModal);
    elements.taskModal.addEventListener('click', (e) => {
        if (e.target === elements.taskModal) closeModal();
    });
    elements.taskForm.addEventListener('submit', handleTaskSubmit);
}

function openModal(taskId = null) {
    editingTaskId = taskId;
    const modalTitle = document.getElementById('modalTitle');
    
    if (taskId) {
        const task = getTasks().find(t => t.id === taskId);
        if (task) {
            modalTitle.textContent = 'ç¼–è¾‘ä»»åŠ¡';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskCategory').value = task.category;
            document.getElementById('taskTime').value = task.time;
            document.getElementById('taskEnergy').value = task.energy;
            document.getElementById('taskUrgency').value = task.urgency;
            document.getElementById('taskXP').value = task.xp;
        }
    } else {
        modalTitle.textContent = 'æ·»åŠ ä»»åŠ¡';
        elements.taskForm.reset();
        document.getElementById('taskTime').value = 30;
        document.getElementById('taskXP').value = 20;
    }
    
    elements.taskModal.classList.remove('hidden');
}

function closeModal() {
    elements.taskModal.classList.add('hidden');
    editingTaskId = null;
}

function handleTaskSubmit(e) {
    e.preventDefault();
    
    const taskData = {
        title: document.getElementById('taskTitle').value.trim(),
        category: document.getElementById('taskCategory').value,
        time: parseInt(document.getElementById('taskTime').value),
        energy: parseInt(document.getElementById('taskEnergy').value),
        urgency: parseInt(document.getElementById('taskUrgency').value),
        xp: parseInt(document.getElementById('taskXP').value),
        deadline: document.getElementById('taskDeadline').value || null
    };
    
    if (!taskData.title) return;
    
    const tasks = getTasks();
    
    if (editingTaskId) {
        const index = tasks.findIndex(t => t.id === editingTaskId);
        if (index !== -1) {
            tasks[index] = { ...tasks[index], ...taskData };
        }
    } else {
        const newTask = {
            id: 'task_' + Date.now(),
            ...taskData,
            status: 'todo',
            createdAt: new Date().toISOString(),
            completedAt: null
        };
        tasks.unshift(newTask);
    }
    
    saveTasks(tasks);
    renderTaskList();
    closeModal();
}

// ============================================
// å¯¼å‡ºAPI
// ============================================

window.Schedule = {
    getTasks,
    saveTasks,
    getRecommendations,
    completeTask,
    addXP: (amount) => window.WebUni?.addXP(amount)
};


// ============================================
// æ—¥å†ä»ªè¡¨ç›˜åŠŸèƒ½
// ============================================

let currentCalendarDate = new Date();
let selectedDate = null;

function initCalendar() {
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    
    if (prevBtn && nextBtn) {
        prevBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        
        nextBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });
        
        renderCalendar();
        updateStats();
    }
}

function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    // æ›´æ–°æœˆä»½æ˜¾ç¤º
    const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    document.getElementById('currentMonth').textContent = `${year}å¹´${monthNames[month]}`;
    
    // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    // è·å–å®Œæˆçš„ä»»åŠ¡æ•°æ®
    const completedByDate = getCompletedTasksByDate();
    
    const calendarDays = document.getElementById('calendarDays');
    calendarDays.innerHTML = '';
    
    const today = new Date();
    const todayStr = formatDate(today);
    
    // ä¸Šæœˆå¡«å……
    const prevMonthLastDay = new Date(year, month, 0).getDate();
    for (let i = startDayOfWeek - 1; i >= 0; i--) {
        const day = prevMonthLastDay - i;
        const dayEl = createDayElement(day, true, null);
        calendarDays.appendChild(dayEl);
    }
    
    // å½“æœˆæ—¥æœŸ
    for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = formatDate(new Date(year, month, day));
        const tasksCount = completedByDate[dateStr] || 0;
        const isToday = dateStr === todayStr;
        const isSelected = selectedDate === dateStr;
        
        const dayEl = createDayElement(day, false, tasksCount, isToday, isSelected, dateStr);
        calendarDays.appendChild(dayEl);
    }
    
    // ä¸‹æœˆå¡«å……
    const totalCells = calendarDays.children.length;
    const remainingCells = 42 - totalCells; // 6è¡Œ x 7åˆ—
    for (let day = 1; day <= remainingCells && totalCells < 42; day++) {
        const dayEl = createDayElement(day, true, null);
        calendarDays.appendChild(dayEl);
    }
}

function createDayElement(day, isOtherMonth, tasksCount, isToday = false, isSelected = false, dateStr = null) {
    const dayEl = document.createElement('div');
    dayEl.className = 'calendar-day';
    dayEl.textContent = day;
    
    if (isOtherMonth) {
        dayEl.classList.add('other-month');
    } else {
        if (isToday) dayEl.classList.add('today');
        if (isSelected) dayEl.classList.add('selected');
        
        if (tasksCount > 0) {
            dayEl.classList.add('has-tasks');
            if (tasksCount >= 5) dayEl.classList.add('level-4');
            else if (tasksCount >= 3) dayEl.classList.add('level-3');
            else if (tasksCount >= 2) dayEl.classList.add('level-2');
            else dayEl.classList.add('level-1');
        }
        
        if (dateStr) {
            dayEl.addEventListener('click', () => selectDate(dateStr));
        }
    }
    
    return dayEl;
}

function selectDate(dateStr) {
    selectedDate = dateStr;
    renderCalendar();
    showDayDetail(dateStr);
}

function showDayDetail(dateStr) {
    const dayDetail = document.getElementById('dayDetail');
    const detailDate = document.getElementById('detailDate');
    const detailTasks = document.getElementById('detailTasks');
    
    const date = new Date(dateStr);
    detailDate.textContent = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ å®Œæˆè®°å½•`;
    
    const tasks = getTasks().filter(t => {
        if (!t.completedAt) return false;
        return formatDate(new Date(t.completedAt)) === dateStr;
    });
    
    if (tasks.length === 0) {
        detailTasks.innerHTML = '<p class="no-tasks-msg">è¿™å¤©æ²¡æœ‰å®Œæˆä»»åŠ¡</p>';
    } else {
        detailTasks.innerHTML = tasks.map(t => `
            <div class="detail-task-item">
                <span class="task-icon">${getCategoryIcon(t.category)}</span>
                <span class="task-name">${t.title}</span>
                <span class="task-xp">+${t.xp}XP</span>
            </div>
        `).join('');
    }
    
    dayDetail.classList.remove('hidden');
}

function getCompletedTasksByDate() {
    const tasks = getTasks();
    const byDate = {};
    
    tasks.forEach(t => {
        if (t.completedAt) {
            const dateStr = formatDate(new Date(t.completedAt));
            byDate[dateStr] = (byDate[dateStr] || 0) + 1;
        }
    });
    
    return byDate;
}

function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function updateStats() {
    const tasks = getTasks();
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    // æœ¬æœˆå®Œæˆæ•°
    const monthCompleted = tasks.filter(t => {
        if (!t.completedAt) return false;
        const d = new Date(t.completedAt);
        return d.getFullYear() === year && d.getMonth() === month;
    });
    
    document.getElementById('monthCompleted').textContent = monthCompleted.length;
    
    // æœ¬æœˆæ€»æ—¶é•¿
    const totalTime = monthCompleted.reduce((sum, t) => sum + (t.time || 0), 0);
    document.getElementById('monthTime').textContent = totalTime;
    
    // è¿ç»­å¤©æ•°
    const streak = calculateStreak();
    document.getElementById('currentStreak').textContent = streak;
}

function calculateStreak() {
    const completedByDate = getCompletedTasksByDate();
    const dates = Object.keys(completedByDate).sort().reverse();
    
    if (dates.length === 0) return 0;
    
    const today = formatDate(new Date());
    const yesterday = formatDate(new Date(Date.now() - 86400000));
    
    // æ£€æŸ¥ä»Šå¤©æˆ–æ˜¨å¤©æ˜¯å¦æœ‰å®Œæˆä»»åŠ¡
    if (dates[0] !== today && dates[0] !== yesterday) return 0;
    
    let streak = 1;
    let currentDate = new Date(dates[0]);
    
    for (let i = 1; i < dates.length; i++) {
        const prevDate = new Date(currentDate);
        prevDate.setDate(prevDate.getDate() - 1);
        
        if (formatDate(prevDate) === dates[i]) {
            streak++;
            currentDate = prevDate;
        } else {
            break;
        }
    }
    
    return streak;
}

// åœ¨åŸæœ‰çš„DOMContentLoadedä¸­æ·»åŠ æ—¥å†åˆå§‹åŒ–
const originalDOMContentLoaded = document.addEventListener;
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(initCalendar, 100);
});

// é‡å†™completeTaskä»¥æ›´æ–°ç»Ÿè®¡
const originalCompleteTask = completeTask;
completeTask = function(taskId) {
    originalCompleteTask(taskId);
    setTimeout(() => {
        renderCalendar();
        updateStats();
    }, 100);
};
